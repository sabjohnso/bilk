#+TITLE: Bilk — Open Issues
#+STARTUP: showall

* Known Issues

** DONE Issue 4: =imports_of_scm= already implemented — Phase 3 plan is stale
:PROPERTIES:
:PRIORITY: C
:END:

[[file:PLAN.org][PLAN.org]] Phase 3 lists "Parse top-level =(import ...)= forms from =.scm=
files" as a task, but [[file:lib/dep_graph.ml::let imports_of_scm][=Dep_graph.imports_of_scm=]] was already implemented
during Phase 1. The plan should be updated to mark this task as complete and
remove it from Phase 3's scope.

** DONE Issue 5: =syntax_to_proper_list= duplicated across modules
:PROPERTIES:
:PRIORITY: B
:END:

Consolidated all 6 copies into [[file:lib/syntax.ml::let rec to_proper_list][=Syntax.to_proper_list=]] with tests in
[[file:test/test_syntax.ml][=test_syntax.ml=]]. Deleted local definitions from =library.ml=,
=package.ml=, =dep_graph.ml=, =instance.ml=, =repository.ml=, and
=lockfile.ml=.

** TODO Issue 6: Duplicate imports produce duplicate DOT edges
:PROPERTIES:
:PRIORITY: C
:END:

If a =.sld= file imports the same library more than once (e.g. via separate
=(import ...)= declarations), [[file:lib/dep_graph.ml::let to_dot][=Dep_graph.to_dot=]] emits duplicate edges in the
Graphviz output. This is cosmetically ugly and can confuse layout algorithms.

Fix: deduplicate =node.imports= when building the graph, or deduplicate
edges in =to_dot=.

** TODO Issue 7: =is_stale= dep lookup is O(n) per import
:PROPERTIES:
:PRIORITY: C
:END:

[[file:lib/build.ml::let is_stale][=Build.is_stale=]] uses =List.find_opt= to resolve each import name to a
node, making it O(imports × nodes). Since =plan= calls =is_stale= for every
node, the overall complexity is O(nodes × imports × nodes). Fine for dozens
of libraries, but will become quadratic at scale.

Fix: build a =Hashtbl= from =name -> node= once in =plan= and pass it to
=is_stale= (or a private helper) instead of the raw list.

** TODO Issue 8: =is_stale= double-stats the FASL file
:PROPERTIES:
:PRIORITY: C
:END:

[[file:lib/build.ml::let is_stale][=Build.is_stale=]] calls =Fasl.is_cache_valid= (which stats both the =.sld=
and =.fasl=), then immediately stats the =.fasl= again to read
=this_mtime= for the dep-newer check.

Fix: inline the mtime comparison or capture the stat result from a single
call and reuse it.

** TODO Issue 9: =test_execute_error= relies on runtime error, not compile error
:PROPERTIES:
:PRIORITY: C
:END:

[[file:test/test_build.ml::let test_execute_error][=test_execute_error=]] uses =(/ 1 "bad")= which is a runtime type error.
The library body happens to run at load time, so it surfaces during
=ensure_library=, but this is fragile — if the compiler ever constant-folded
or the VM deferred execution, the test might stop raising.

Fix: use a syntax error (e.g. unbalanced parens) or an unresolved import to
guarantee a compile-time failure.

** TODO Issue 10: Property tests use fixed inputs instead of generators
:PROPERTIES:
:PRIORITY: B
:END:

[[file:test/test_build.ml::let test_execute_makes_fresh][=test_execute_makes_fresh=]] and [[file:test/test_build.ml::let test_plan_preserves_topo_order][=test_plan_preserves_topo_order=]] use
=QCheck2.Gen.return ()= with =~count:5=, running the same fixed 2- or 3-node
graph five times. These are effectively example tests.

Fix: generate random graph structures (varying chain length, diamond width,
which nodes start stale), following the pattern in [[file:test/test_dep_graph.ml::let test_topological_order_property][=test_dep_graph.ml=]]
which uses =QCheck2.Gen.int_range= to vary structure.

** TODO Issue 11: CLI pluralization calls =List.length= twice
:PROPERTIES:
:PRIORITY: C
:END:

In [[file:bin/main.ml::let run_build][=run_build=]], the dry-run and build output both compute
=List.length actions= (or =results=) twice — once for the count and once for
the pluralization conditional.

Fix: bind =let n = List.length actions in= and reuse.

** TODO Issue 12: REPL banner ordering
:PROPERTIES:
:PRIORITY: C
:END:

[[file:bin/main.ml::let run_repl][=run_repl=]] prints the project banner, then auto-build output (on
stderr), then the Bilk version banner.  The result is:

#+begin_example
Project: my-project 0.1.0
Auto-built 3 libraries.
Bilk Scheme 0.1.0
Type ,help for REPL commands, Ctrl-D to exit.
#+end_example

The build output is sandwiched between two banners.  Consider combining
them into a single greeting (e.g. =Bilk Scheme 0.1.0 — Project: my-project
0.1.0=) or printing the version line first.

** TODO Issue 13: =,deps= on a builtin library prints a bare name
:PROPERTIES:
:PRIORITY: C
:END:

Typing =,deps (scheme base)= calls [[file:lib/dep_graph.ml::let build_graph][=Dep_graph.build_graph=]] with
=(scheme base)= as the root.  Since builtins are skipped, the node list is
empty.  [[file:lib/dep_graph.ml::let format_tree][=Dep_graph.format_tree=]] then prints =(scheme base)= with no
children and no explanation.

Fix: detect when the root is a builtin (or absent from the node list) and
print a message like "built-in library (no source dependencies)" instead.

** TODO Issue 14: REPL command dispatch is growing long
:PROPERTIES:
:PRIORITY: C
:END:

[[file:bin/main.ml::let handle_repl_command][=handle_repl_command=]] now handles 14 commands via a mix of exact
=match= arms and =String.sub= prefix checks in the fallback =| _= arm.
This pattern is correct but increasingly hard to maintain.

Fix: refactor to a command table (name, arity, handler) and a generic
dispatcher.  Not urgent — the current code is functional — but will become
necessary as more commands are added.

* Phase 6 (Watch Mode) — Minor Issues

** TODO Issue 15: Missing =caml_enter_blocking_section= in inotify C stubs
:PROPERTIES:
:PRIORITY: C
:END:

The =read= call in [[file:lib/inotify_stubs.c::bilk_inotify_read][=bilk_inotify_read=]] and =inotify_add_watch=
in [[file:lib/inotify_stubs.c::bilk_inotify_add_watch][=bilk_inotify_add_watch=]] should release the OCaml runtime lock
via =caml_enter_blocking_section= / =caml_leave_blocking_section=.
This follows the pattern used by OCaml's own =unix_read= stub.  In
practice the fd is =IN_NONBLOCK= so =read= returns immediately, but
=inotify_add_watch= can block on directory stat.

** TODO Issue 16: Document fixed-size offsets array in =bilk_inotify_read=
:PROPERTIES:
:PRIORITY: C
:END:

[[file:lib/inotify_stubs.c::64][Line 64]]: =int offsets[256]= — each =inotify_event= is at least 16
bytes, so a 4096-byte buffer can hold at most 256 minimum-size events.
The math works out but the assumption is implicit.  Add a comment
documenting why 256 is sufficient.

** TODO Issue 17: C-side mask constant functions allocate boxed =int64= per call
:PROPERTIES:
:PRIORITY: C
:END:

The mask constant C functions ([[file:lib/inotify_stubs.c::95][=bilk_in_modify= etc.]]) call
=caml_copy_int64= which heap-allocates a boxed value on every call.
Now that the OCaml side caches them at module init this is only called
once, but if someone calls the externals directly they pay allocation
each time.

** TODO Issue 18: =poll_dirs= uses =ref= while other mutable fields use =mutable=
:PROPERTIES:
:PRIORITY: C
:END:

Style inconsistency in [[file:lib/watch.ml::51][=watch.ml=]]: =inotify_fd= is =mutable= but
=poll_dirs= is a =string list ref=.  Both should use the same mutation
style — prefer =mutable poll_dirs : string list= for consistency with
the rest of the record.

** TODO Issue 19: =scan_mtimes= re-walks =list_dirs_recursive= on every poll
:PROPERTIES:
:PRIORITY: C
:END:

[[file:lib/watch.ml::72][=scan_mtimes=]] calls =list_dirs_recursive= on every poll.
=add_directory_polling= already called it for the initial snapshot.
For large trees this is wasteful.  Acceptable since polling is the
slow path, but caching the directory list and only re-scanning when
new directories appear would improve performance.

** TODO Issue 20: =add_directory_inotify= silences all =Unix_error=, not just =ENOSPC=
:PROPERTIES:
:PRIORITY: C
:END:

[[file:lib/watch.ml::127][=add_directory_inotify=]]: the =try ... with Unix.Unix_error _ -> -1=
catches all Unix errors including genuine failures like =EACCES=.  The
comment says "wd = -1 means ENOSPC" but the catch-all silences other
errors too.  Should at least log =EACCES= and similar permission
errors to stderr.

** TODO Issue 21: =builtins= captured once at REPL start in watch callback
:PROPERTIES:
:PRIORITY: C
:END:

[[file:bin/main.ml::654][=Build.builtin_library_names inst=]] is computed once when the
=on_idle= closure is created.  If the instance's built-in set could
change (unlikely but possible with extensions), this would go stale.

** TODO Issue 22: Watch message can confuse multi-line editor cursor position
:PROPERTIES:
:PRIORITY: C
:END:

The =\r\x1b[K= before the =[watch]= message ([[file:bin/main.ml::681][line 681]]) clears the
current line before printing.  But if the user is mid-typing a
multi-line expression, this writes to the terminal without the line
editor knowing — the next render will be confused about cursor
position.  This is an inherent limitation of the "idle callback writes
to stderr" approach and would require deeper editor integration to
solve.

** TODO Issue 23: =do_build= rebuilds dep graph on every watch iteration
:PROPERTIES:
:PRIORITY: C
:END:

[[file:bin/main.ml::1284][=do_build=]] calls =Dep_graph.build_graph= every time, which re-scans
the filesystem for =.sld= files.  This is correct and intentional (new
files may appear between iterations), but could be optimized by only
re-scanning on =Created= or =Deleted= events and reusing the cached
graph for =Modified=-only batches.

** TODO Issue 24: =make_polling_watcher= doesn't guarantee polling backend in tests
:PROPERTIES:
:PRIORITY: C
:END:

[[file:test/test_watch.ml::29][=make_polling_watcher=]] calls =Watch.create= which uses inotify on
Linux.  The "polling" test group actually exercises the inotify backend
on Linux.  To truly test the polling backend in isolation,
=Watch.create= would need a =~backend= parameter or a separate
constructor.

** TODO Issue 25: Timing-dependent tests in =test_watch.ml=
:PROPERTIES:
:PRIORITY: C
:END:

Several tests in [[file:test/test_watch.ml][=test_watch.ml=]] use =Unix.sleepf 0.05= to ensure
mtime changes.  On a heavily-loaded system or a filesystem with
1-second mtime granularity (e.g. older ext3, FAT), this could be
flaky.  Acceptable for a modern Linux dev machine with sub-second
resolution.

* Phase 9 (Remote Repositories) — Minor Issues

** DONE Issue 26: =syntax_to_proper_list= duplicated in =repository.ml=
:PROPERTIES:
:PRIORITY: B
:END:

Resolved by Issue 5 — all copies consolidated into [[file:lib/syntax.ml::let rec to_proper_list][=Syntax.to_proper_list=]].

** TODO Issue 27: Repo names with special characters don't round-trip
:PROPERTIES:
:PRIORITY: C
:END:

Repository names are serialized as Scheme symbols in
[[file:lib/repository.ml::let save_repos][=save_repos=]].  Names containing spaces, parentheses,
or other non-identifier characters won't survive a save/load
round-trip, since =Datum.to_string= emits bare symbols and the reader
tokenizes them differently.

Fix: validate repo names on add (reject non-identifier characters),
or quote names as strings instead of symbols.

** TODO Issue 28: =pkg_fetch= gives misleading error when clones are stale
:PROPERTIES:
:PRIORITY: C
:END:

[[file:bin/main.ml::let pkg_fetch][=pkg_fetch=]] scans cached clones for available versions.
If clones are out of date, =scan_versions= silently returns stale
data and the error is "package not found in any repository" — even
if the package exists upstream.

Fix: suggest =bilk pkg repo update= in the error message, or
auto-sync before scanning.

** TODO Issue 29: Backtracking provenance pollutes conflict error heuristic
:PROPERTIES:
:PRIORITY: C
:END:

[[file:lib/pkg_manager.ml::| None ->][=resolve= error path]] accumulates provenance from all
backtracking attempts into a single mutable hashtable.  When the
solver returns =None= (no valid combination found), the heuristic
that picks the "most constrained" dependency to report uses
combined constraints from incompatible backtracking paths.  This
can mis-identify the actual culprit or produce a confusing error
message.

Fix: either snapshot and restore provenance per backtracking
attempt, or collect provenance only on the final failed path.

** TODO Issue 30: Redundant =installed_versions= calls on resolver error path
:PROPERTIES:
:PRIORITY: C
:END:

[[file:lib/pkg_manager.ml::let format_conflict_error][=format_conflict_error=]] calls
=installed_versions= to list available versions.  The =None=
error-path heuristic in [[file:lib/pkg_manager.ml::| None ->][=resolve=]] also calls
=installed_versions= for every provenance entry to find the
failed dependency.  These are redundant filesystem reads for the
same data.

Fix: pass the already-computed versions into
=format_conflict_error=, or cache =installed_versions= results
during resolution.

* Project Review (2026-02-16)

** HIGH Priority

*** DONE Issue 31: REPL server binds to all interfaces with no authentication
:PROPERTIES:
:PRIORITY: A
:CATEGORY: security
:END:

[[file:lib/repl_server.ml::127][lib/repl_server.ml:127]] — ~Unix.inet_addr_any~ exposes full Scheme eval to
the network. Should default to ~inet_addr_loopback~ (localhost only), require
explicit ~--bind 0.0.0.0~ flag for network binding.

Also affects:
- [[file:bin/main.ml::1703][bin/main.ml:1703]] — DAP server ~inet_addr_any~
- [[file:bin/main.ml::1753][bin/main.ml:1753]] — LSP server ~inet_addr_any~

**** Plan
- Add ~bind_address~ field to ~Repl_server.config~ (default ~inet_addr_loopback~)
- Update ~.mli~ to document the field
- Add ~--bind~ flag to ~make_serve_cmd~ in ~bin/main.ml~
- Change DAP/LSP servers in ~bin/main.ml~ to use ~inet_addr_loopback~
- Update test configs in ~test/test_repl_server.ml~ to include ~bind_address~

*** TODO Issue 32: C FFI: ~bilk_error_message~ returns dangling pointer
:PROPERTIES:
:PRIORITY: A
:CATEGORY: security
:END:

[[file:lib/bilk_stubs.c::176][lib/bilk_stubs.c:176]] — Returns ~String_val(r)~ after ~CAMLreturnT~
unregisters the GC root. Any subsequent allocation could invalidate the
pointer.

**** Plan
- Change return type from ~const char *~ to ~char *~
- Use ~strdup(String_val(r))~ before ~CAMLreturnT~
- Update [[file:lib/bilk.h::85][lib/bilk.h:85]] doc to say caller must ~free()~
- Update [[file:test/test_c_embed_impl.c::106][test/test_c_embed_impl.c:106]] to ~free(msg)~

*** TODO Issue 33: C FFI: ~bilk_fixnum~ truncates ~long~ to ~int~
:PROPERTIES:
:PRIORITY: A
:CATEGORY: correctness
:END:

[[file:lib/bilk_stubs.c::260][lib/bilk_stubs.c:260]] — On 64-bit systems, ~long~ is 8 bytes but the cast
to ~int~ silently truncates values exceeding ~INT_MAX~.

**** Plan
- Replace ~Val_int((int)n)~ with ~Val_long(n)~ to preserve full range

*** TODO Issue 34: C FFI: Missing ~malloc~ NULL check
:PROPERTIES:
:PRIORITY: A
:CATEGORY: correctness
:END:

[[file:lib/bilk_stubs.c::40][lib/bilk_stubs.c:40]] — ~argv = malloc(...)~ not checked for NULL in
~bilk_c_dispatch_primitive~.

**** Plan
- Add ~if (argv == NULL) CAMLreturn(Val_int(0));~ after malloc

*** TODO Issue 35: R7RS: ~eq?~ is alias for ~eqv?~
:PROPERTIES:
:PRIORITY: A
:CATEGORY: correctness
:END:

[[file:lib/instance.ml::308][lib/instance.ml:308]] — ~prim_eq args = prim_eqv args~. Per R7RS, ~eq?~
should be pointer identity. Mutable objects (pairs, vectors, strings) should
compare by identity under ~eq?~, not structural content.

**** Plan
- Write failing tests: ~(eq? (cons 1 2) (cons 1 2))~ should be ~#f~; ~(let ((p (cons 1 2))) (eq? p p))~ should be ~#t~; same for vectors, strings, closures
- Implement ~prim_eq~ with value comparison for immutable scalars (bool, fixnum, bignum, char, symbol, nil, eof, void) and physical identity (~==~) for everything else

*** TODO Issue 36: R7RS: ~map~ / ~for-each~ only handle single list
:PROPERTIES:
:PRIORITY: A
:CATEGORY: correctness
:END:

[[file:lib/instance.ml::2793][lib/instance.ml:2793-2801]] — Boot definitions only accept one list argument.
R7RS requires multi-list: ~(map + '(1 2) '(3 4))~ should produce ~(4 6)~.

**** Plan
- Write failing tests for multi-list ~map~, ~for-each~, ~string-map~, ~string-for-each~, ~vector-map~, ~vector-for-each~
- Rewrite boot definitions using rest args (~. lsts~) with fast single-list path and general multi-list path
- Shortest list determines result length per R7RS

** MEDIUM Priority

*** TODO Issue 37: ~instance.ml~ is a god object (5,769 lines)
:PROPERTIES:
:PRIORITY: B
:CATEGORY: architecture
:END:

Combines 8+ responsibilities: primitive implementations (~2200 lines),
registration (~500 lines), library name manifests (~300 lines), library
loading, evaluation pipeline, instance state, SRFI implementations (hash
tables, char-sets, regexp — each 300-500 lines), and forward references.

**** Recommended decomposition
1. Extract ~Primitives~ module (~3500 lines of pure ~Datum.t list -> Datum.t~)
2. Extract ~Scheme_libraries~ module (export name lists + registration)
3. Extract SRFI modules: ~Srfi_69.ml~, ~Srfi_14.ml~, ~Srfi_115.ml~
4. Extract ~Library_loader~ module (~300 lines)

*** TODO Issue 38: ~bin/main.ml~ is 2,280 lines with mixed concerns
:PROPERTIES:
:PRIORITY: B
:CATEGORY: architecture
:END:

Config loading, error formatting, instance setup, 20+ REPL commands, full
REPL loop with completion/watch/sessions, 14 cmdliner subcommands, manual
subcommand dispatch. Should factor REPL commands, config management, and
subcommand definitions into separate modules.

*** TODO Issue 39: Expander raises ~Compiler.Compile_error~
:PROPERTIES:
:PRIORITY: B
:CATEGORY: architecture
:END:

[[file:lib/expander.ml::1][lib/expander.ml:1]] and [[file:lib/library.ml::49][lib/library.ml:49]] — Cross-module coupling. Should
have a shared ~Expand_error~ or move the exception to a shared module.

*** TODO Issue 40: ~Obj.t~ usage for type-safety workarounds
:PROPERTIES:
:PRIORITY: B
:CATEGORY: architecture
:END:

5 uses across ~datum.ml~, ~reader.ml~, ~instance.ml~, ~port.mli~ — breaks
type safety to work around mutual recursion in type definitions (regexp and
readtable). A GADT or functor approach could eliminate them.

*** TODO Issue 41: Compiler ~patch_jump~ is O(n^2)
:PROPERTIES:
:PRIORITY: B
:CATEGORY: performance
:END:

[[file:lib/compiler.ml::50][lib/compiler.ml:50-58]] — Converts reversed instruction list to array,
patches one element, converts back. For forms like ~cond~ with many clauses,
this is called per-clause.

**** Plan
- Change ~state.instructions~ from ~Opcode.t list~ to a resizable array (e.g. ~Buffer~-style)
- Patch in-place with O(1) array access
- Keep ~emit~, ~current_pc~, and finalization working with new representation

*** TODO Issue 42: VM fixed stack size of 1024
:PROPERTIES:
:PRIORITY: B
:CATEGORY: correctness
:END:

[[file:lib/vm.ml::41][lib/vm.ml:41]] — Deep recursion or large argument lists could overflow.
Should be growable (double on overflow).

**** Plan
- Make ~stack~ and ~stack_size~ into refs
- Grow by doubling in ~push~ when at capacity, up to ~max_stack_size~ (1M)
- Add ~ensure_stack_capacity~ for ~restore_continuation~ blit
- Write test: ~(define (sum n) (if (= n 0) 0 (+ n (sum (- n 1)))))~ with n=2000

*** TODO Issue 43: FASL deserialization has no vector size limit
:PROPERTIES:
:PRIORITY: B
:CATEGORY: security
:END:

[[file:lib/fasl.ml::221][lib/fasl.ml:221]] — A crafted FASL claiming ~count = 2^31 - 1~ vector
elements could cause a denial-of-service via huge allocation. No recursion
depth limit either.

**** Plan
- Add ~max_collection_size~ (10M) and ~max_recursion_depth~ (10K) constants
- Add optional ~depth~ parameter to ~read_datum~, increment on recursive calls
- Check vector count against ~max_collection_size~ before ~Array.init~
- Check instruction count in ~read_code_obj~ similarly

*** TODO Issue 44: No OCaml version constraint in dune-project
:PROPERTIES:
:PRIORITY: B
:CATEGORY: build
:END:

[[file:dune-project][dune-project]] — Project requires OCaml 5.3.0+BER but does not specify
~(ocaml (>= 5.3.0))~ in dependencies.

**** Plan
- Add ~(ocaml (>= 5.3.0))~ to the ~depends~ list in ~dune-project~

*** TODO Issue 45: Hardcoded absolute source path in build
:PROPERTIES:
:PRIORITY: B
:CATEGORY: build
:END:

[[file:lib/dune::9][lib/dune:9-13]] — ~bilk_config.ml~ bakes an absolute source-tree path into
the compiled library. Only valid during development, not after install.

** LOW Priority

*** TODO Issue 46: ~syntax_list_to_list~ defined 3 times
:PROPERTIES:
:PRIORITY: C
:CATEGORY: duplication
:END:

[[file:lib/expander.ml::60][expander.ml:60]], [[file:lib/compiler.ml::62][compiler.ml:62]], [[file:lib/instance.ml::5287][instance.ml:5287]] — Nearly identical.
~Syntax.to_proper_list~ already exists in [[file:lib/syntax.mli::48][syntax.mli:48]] but none use it.

**** Plan
- Replace all 3 with calls to ~Syntax.to_proper_list~

*** TODO Issue 47: Numeric helpers duplicated between reader and instance
:PROPERTIES:
:PRIORITY: C
:CATEGORY: duplication
:END:

~is_exact_syntax~ / ~is_exact_datum~, ~to_inexact_syntax~ / ~to_inexact_datum~,
etc. — Parallel ~Syntax.datum~ and ~Datum.t~ versions of the same logic.

*** TODO Issue 48: Dead code
:PROPERTIES:
:PRIORITY: C
:CATEGORY: cleanup
:END:

- ~_require_rx~ in [[file:lib/instance.ml::4969][instance.ml:4969]] — Never called, superseded by ~ensure_rx~
- ~ignore loc~ in [[file:lib/compiler.ml::533][compiler.ml:533,622]] — Unused parameters
- Warning suppressors in [[file:lib/expander.ml::26][expander.ml:26-27]] — ~let _ = Var~

*** TODO Issue 49: ~Char~ always printed as hex
:PROPERTIES:
:PRIORITY: C
:CATEGORY: correctness
:END:

[[file:lib/datum.ml::195][lib/datum.ml:195]] — ~#\x04NN~ format. R7RS recommends named characters
(~#\space~, ~#\newline~) and printable ASCII as themselves.

**** Plan
- Match on code point for R7RS named chars: null(0x00), alarm(0x07), backspace(0x08), tab(0x09), newline(0x0A), return(0x0D), escape(0x1B), space(0x20), delete(0x7F)
- Printable ASCII (0x21-0x7E): print as ~#\c~
- Everything else: keep hex format

*** TODO Issue 50: Runtime errors lack source locations
:PROPERTIES:
:PRIORITY: C
:CATEGORY: diagnostics
:END:

~Vm.Runtime_error of string~ carries no ~Loc.t~. The VM has ~source_map~
but primitive errors discard location context.

*** TODO Issue 51: Placeholder metadata in dune-project
:PROPERTIES:
:PRIORITY: C
:CATEGORY: distribution
:END:

[[file:dune-project][dune-project]] lines 8-33 contain template defaults: ~"Author Name"~, ~"A short synopsis"~,
~"github username/reponame"~, etc. Blocks ~opam publish~.

*** TODO Issue 52: LICENSE says "wile-scheme"
:PROPERTIES:
:PRIORITY: C
:CATEGORY: distribution
:END:

[[file:LICENSE::3][LICENSE:3]] — Should say "bilk" or the author's name.

*** TODO Issue 53: No CHANGES.md
:PROPERTIES:
:PRIORITY: C
:CATEGORY: distribution
:END:

*** TODO Issue 54: ~(-ldl)~ is Linux-specific
:PROPERTIES:
:PRIORITY: C
:CATEGORY: build
:END:

[[file:lib/dune::6][lib/dune:6]] — macOS links ~-ldl~ implicitly. Should be conditional.

*** TODO Issue 55: Monolithic library
:PROPERTIES:
:PRIORITY: C
:CATEGORY: build
:END:

All 50 modules compile into one ~bilk~ library. Splitting into ~bilk.core~,
~bilk.repl~, ~bilk.tools~ would reduce downstream link overhead.

** Test Suite Gaps

*** TODO Issue 56: Expander tests are thin (141 lines for 1,773-line module)
:PROPERTIES:
:PRIORITY: B
:CATEGORY: testing
:END:

No test for ~syntax-rules~ pattern matching, ellipsis, or hygiene in isolation.

*** TODO Issue 57: Instance primitives — 210 registered, only a subset tested individually
:PROPERTIES:
:PRIORITY: C
:CATEGORY: testing
:END:

*** TODO Issue 58: No formal R7RS conformance suite
:PROPERTIES:
:PRIORITY: B
:CATEGORY: testing
:END:

*** TODO Issue 59: No tail-call verification per R7RS 3.5 for all required contexts
:PROPERTIES:
:PRIORITY: B
:CATEGORY: testing
:END:

*** TODO Issue 60: ~parameterize~ / ~make-parameter~ untested
:PROPERTIES:
:PRIORITY: C
:CATEGORY: testing
:END:

*** TODO Issue 61: Test helper duplication
:PROPERTIES:
:PRIORITY: C
:CATEGORY: testing
:END:

~datum_testable~, ~check_datum~, ~eval~, ~with_temp_dir~, ~write_file~ copy-pasted
across 13+ files. Should extract ~test/test_helpers.ml~.

*** TODO Issue 62: No property tests in ~test_vm.ml~ or ~test_datum.ml~
:PROPERTIES:
:PRIORITY: C
:CATEGORY: testing
:END:

* Remote REPL Security Review (2026-02-16)

** CRITICAL

*** DONE Issue 63: Path traversal in server comma commands
:PROPERTIES:
:PRIORITY: A
:CATEGORY: security
:END:

[[file:lib/repl_server.ml][repl_server.ml]] — ~,load~, ~,save-session~, and ~,load-session~ accept
arbitrary file paths from the remote client with no ~realpath()~ check,
whitelist, or symlink protection. A remote client can read or write
arbitrary files accessible to the server process.

**** Resolution
- ~,save-session~ and ~,load-session~ now take a name (not a path),
  stored under =~/.bilk/sessions/<name>.bses= via [[file:lib/session_store.ml][Session_store]] module.
  Names are validated to reject path separators, ~.~, ~..~, and null bytes.
- ~,load~ now resolves paths via ~Unix.realpath~ and rejects anything
  outside ~Sys.getcwd()~ or ~Instance.search_paths~
  ([[file:lib/repl_server.ml::safe_resolve_path][safe_resolve_path]] helper).
- Tests: [[file:test/test_session_store.ml][test_session_store.ml]] (12 tests),
  [[file:test/test_repl_server.ml][test_repl_server.ml]] named_sessions + path_restriction groups.

*** DONE Issue 64: No max frame size in protocol
:PROPERTIES:
:PRIORITY: A
:CATEGORY: security
:END:

[[file:lib/repl_protocol.ml][repl_protocol.ml]] — A malicious peer can send a frame header claiming
a 4GB payload, causing out-of-memory. The ~frame_available~ function
also risks integer overflow when ~offset + 4 + payload_len~ wraps on
63-bit OCaml ints.

**** Resolution
- Added ~max_frame_size~ constant (16 MiB) exposed in [[file:lib/repl_protocol.mli][repl_protocol.mli]]
- ~frame_available~ now checks ~payload_len > max_frame_size~ before
  the addition, raising ~Protocol_error "frame too large"~ — this
  eliminates the integer overflow risk since 16 MiB + any realistic
  offset fits in 63-bit OCaml ints
- ~read_client_msg~ / ~read_server_msg~ already call ~frame_available~
  first, so the guard propagates to all deserialization paths
- Tests: 4 example tests + 1 QCheck2 property test in
  [[file:test/test_repl_protocol.ml][test_repl_protocol.ml]] ~max_frame_size~ group

*** DONE Issue 65: Flag injection via ~serve_args~ in SSH connect
:PROPERTIES:
:PRIORITY: A
:CATEGORY: security
:END:

[[file:lib/ssh_connect.ml][ssh_connect.ml]] — Arguments in ~serve_args~ are passed directly to the
remote ~bilk serve~ command. A malicious ~serve_args~ value can inject
~--insecure --bind 0.0.0.0~, bypassing the security model.

**** Resolution
- ~bilk connect~ now uses typed cmdliner flags (~--serve-port~,
  ~--auto-checkpoint~, ~--name~, ~--session-timeout~) instead of
  raw string passthrough.
- [[file:lib/ssh_connect.ml::serve_config][Ssh_connect.serve_config]] type structurally excludes
  ~--insecure~ and ~--bind~ — the type has no fields for those.
- [[file:lib/ssh_connect.ml::build_serve_args][Ssh_connect.build_serve_args]] constructs arguments from typed config.
- QCheck2 property test: output never contains ~--insecure~ or ~--bind~.
- Tests: [[file:test/test_ssh_connect.ml][test_ssh_connect.ml]] build_serve_args group (5 tests).

*** DONE Issue 66: No server authentication (MITM possible)
:PROPERTIES:
:PRIORITY: A
:CATEGORY: security
:END:

[[file:lib/repl_client.ml][repl_client.ml]] — The client does not verify the server's identity.
Even with encryption, if an attacker intercepts the shared key during
the SSH bootstrap or via other means, MITM is possible. There is no
certificate pinning, no host key verification, and no trust-on-first-use
mechanism.

**** Resolution
- Implemented 3-message mutual challenge-response using HMAC-SHA256
  with the pre-shared key.
- After TCP connect (before any Eval/Complete messages), the server
  sends =Auth_challenge(nonce)=, the client responds with
  =Auth_response(HMAC, client_nonce)=, and the server verifies and
  sends =Auth_ok(HMAC)= or =Auth_deny=. Both sides prove knowledge
  of the key.
- Crypto primitives: [[file:lib/repl_crypto.ml::auth_challenge][auth_challenge]], [[file:lib/repl_crypto.ml::auth_response][auth_response]],
  [[file:lib/repl_crypto.ml::verify_auth][verify_auth]], [[file:lib/repl_crypto.ml::key_fingerprint][key_fingerprint]] in =repl_crypto.ml=.
- Protocol messages: =Auth_challenge= (0x89), =Auth_response= (0x07),
  =Auth_ok= (0x8a), =Auth_deny= (0x8b) in =repl_protocol.ml=.
- Server handshake: [[file:lib/repl_server.ml::authenticate_client][authenticate_client]] integrated into =run=
  after =accept=.
- Client handshake: [[file:lib/repl_client.ml::authenticate][authenticate]] integrated into =connect=
  after socket connection.
- Key fingerprint displayed on server startup and client connect
  for visual verification.
- Insecure mode (=--insecure=): skips auth entirely (current behavior).
- Tests: 8 in =test_repl_crypto.ml=, 6 in =test_repl_protocol.ml=,
  4 in =test_repl_server.ml=, 3 in =test_repl_client.ml=.

*** DONE Issue 67: Unbounded ~recv_buf~ growth in client
:PROPERTIES:
:PRIORITY: A
:CATEGORY: security
:END:

[[file:lib/repl_client.ml][repl_client.ml]] — A malicious server can send data that never contains
a complete frame, causing ~recv_buf~ to grow without bound until OOM.

**** Resolution
- Added ~recv_buf~ overflow check in [[file:lib/repl_client.ml::recv_msg][recv_msg]]: after each
  read, if ~Buffer.length > max_frame_size + 4~ raises
  ~Protocol_error "recv buffer overflow"~ (defense-in-depth
  alongside Issue 64's ~frame_available~ guard)
- Tests: [[file:test/test_repl_client.ml][test_repl_client.ml]] ~recv_buf_bound~ group
  (2 tests: oversized header rejected, normal large frame OK)

** HIGH

*** DONE Issue 68: Unbounded eval input/output in server
:PROPERTIES:
:PRIORITY: A
:CATEGORY: security
:END:

[[file:lib/repl_server.ml][repl_server.ml]] — No size limits on eval expressions received from
clients or on result strings sent back. A client can send a multi-GB
expression or trigger output that exhausts server memory.

**** Resolution
- Added ~max_eval_input~ (1 MiB) and ~max_eval_output~ (16 MiB)
  constants in [[file:lib/repl_server.ml][repl_server.ml]]
- Input guard in [[file:lib/repl_server.ml::handle_eval][handle_eval]]: expressions exceeding
  ~max_eval_input~ are rejected with ~Error "input too large"~
- Output truncation via [[file:lib/repl_server.ml::truncate_output][truncate_output]]: captured stdout,
  stderr, and result strings exceeding ~max_eval_output~ are
  truncated with ~"[output truncated]"~ suffix
- Server ~recv_buf~ overflow check in [[file:lib/repl_server.ml::run][run]]: disconnects
  clients whose accumulated data exceeds ~max_frame_size + 4~
- Tests: [[file:test/test_repl_server.ml][test_repl_server.ml]] ~eval_bounds~ group (3 tests:
  input too large, moderate output OK, normal under limit)

*** DONE Issue 69: FD leak on client replacement in server
:PROPERTIES:
:PRIORITY: B
:CATEGORY: correctness
:END:

[[file:lib/repl_server.ml][repl_server.ml]] — ~accept_client~ overwrites ~t.client_fd~ without
closing the previous fd. If a second client connects while the first
is still attached, the old fd is leaked.

**** Resolution
- [[file:lib/repl_server.ml::accept_client][accept_client]] now closes the existing ~client_fd~ (if any)
  before assigning the new one.
- Test: [[file:test/test_repl_server.ml][test_repl_server.ml]] ~fd_leak~ group verifies the old
  server-side fd is closed after replacement (write raises ~EBADF~).

*** TODO Issue 70: Infinite loop in ~eval_remote~
:PROPERTIES:
:PRIORITY: B
:CATEGORY: correctness
:END:

[[file:lib/repl_client.ml][repl_client.ml]] — ~eval_remote~ loops calling ~recv_msg~ until it
receives ~Result~ or ~Error~. If the server never sends either (e.g.
due to a bug or hang), the client loops forever with no timeout.

**** Plan
- Add a timeout (e.g. 60s configurable) to ~eval_remote~
- On timeout, return an error message rather than blocking indefinitely
- Alternatively, use ~Unix.select~ with a deadline in the receive loop

*** TODO Issue 71: ~BILK_KEY~ cleanup incomplete
:PROPERTIES:
:PRIORITY: B
:CATEGORY: security
:END:

[[file:bin/main.ml][bin/main.ml]] — ~Unix.putenv "BILK_KEY" ""~ sets the variable to an
empty string rather than unsetting it. The key may still appear in
~/proc/*/environ~ (as ~BILK_KEY=~). OCaml has no ~unsetenv~ binding.

**** Plan
- Write a C stub for ~unsetenv("BILK_KEY")~ or use ~Sys.remove~ if
  available in newer OCaml versions
- Alternatively, accept the limitation and document it, since the empty
  value is not usable as a key

*** DONE Issue 72: Theme path traversal via ~,theme~
:PROPERTIES:
:PRIORITY: B
:CATEGORY: security
:END:

[[file:lib/repl_client.ml][repl_client.ml]] — ~,theme ../../etc/passwd~ could read arbitrary files
through ~resolve_theme~ if it loads theme definitions from file paths
without validation.

**** Resolution
- Added [[file:lib/repl_client.ml::validate_theme_name][validate_theme_name]]: built-in names (~dark~, ~light~,
  ~none~, ~off~) always accepted; custom names must be non-empty and
  contain no path separators (~/~, ~\~), ~..~, or null bytes.
- ~resolve_theme~ in both [[file:lib/repl_client.ml::resolve_theme][repl_client.ml]] and [[file:bin/main.ml::resolve_theme][bin/main.ml]]
  now validates the name and resolves custom themes under
  =~/.bilk/themes/<name>.scm= instead of accepting arbitrary paths.
- Tests: 11 tests in [[file:test/test_repl_client.ml][test_repl_client.ml]] ~theme_validation~ group
  (built-in acceptance, custom names, path traversal rejection,
  slash rejection, dotdot rejection, null byte rejection, empty rejection).

** MEDIUM

*** TODO Issue 73: Completions count unchecked in protocol
:PROPERTIES:
:PRIORITY: B
:CATEGORY: security
:END:

[[file:lib/repl_protocol.ml][repl_protocol.ml]] — The completions message reads a u16 count (up to
65535) but doesn't validate that the payload contains enough data for
that many entries. A crafted message could cause an out-of-bounds read.

**** Plan
- Track remaining payload bytes while reading completions
- Reject message if count exceeds available data
- Write test: malformed completions message handled gracefully

*** TODO Issue 74: Error messages leak server file paths
:PROPERTIES:
:PRIORITY: B
:CATEGORY: security
:END:

[[file:lib/repl_server.ml][repl_server.ml]] — ~Sys_error~ messages (containing full filesystem
paths) are forwarded as ~Error~ messages to the remote client, leaking
information about the server's directory layout.

**** Plan
- Sanitize error messages before sending: strip absolute paths or
  replace with relative paths
- Or catch ~Sys_error~ specifically and return a generic message

*** TODO Issue 75: No port validation in SSH connect
:PROPERTIES:
:PRIORITY: C
:CATEGORY: correctness
:END:

[[file:lib/ssh_connect.ml][ssh_connect.ml]] — Port values are not validated: negative, zero, or
>65535 values are accepted and passed to the remote command.

**** Plan
- Validate port range (1-65535) before constructing the SSH command
- Return error for out-of-range values

*** TODO Issue 76: ~Read_request~ prompt injection
:PROPERTIES:
:PRIORITY: C
:CATEGORY: security
:END:

[[file:lib/repl_client.ml][repl_client.ml]] — A malicious server can send ~Read_request~ with an
arbitrary prompt string, potentially social-engineering the user into
entering credentials or sensitive data that gets sent back to the server.

**** Plan
- Prefix all server-originated prompts with a clear indicator (e.g.
  ~[remote]~) so users know the prompt comes from the server
- Optionally, allow users to deny read requests

*** TODO Issue 77: Signal handler safety
:PROPERTIES:
:PRIORITY: C
:CATEGORY: correctness
:END:

[[file:lib/repl_server.ml][repl_server.ml]] and [[file:lib/repl_client.ml][repl_client.ml]] — Signal handlers
perform I/O operations (checkpoint writes, message sends) instead of
setting a flag and deferring the work. This is not async-signal-safe
and can cause deadlocks or corruption if the signal interrupts a
critical section.

**** Plan
- Change signal handlers to set a ~volatile~ flag
- Check the flag in the main event loop and perform cleanup there

** LOW

*** TODO Issue 78: Custom base64 codec in repl_crypto
:PROPERTIES:
:PRIORITY: C
:CATEGORY: security
:END:

[[file:lib/repl_crypto.ml][repl_crypto.ml]] — Uses a hand-rolled base64 encode/decode instead of
a standard, audited library. Increases risk of subtle encoding bugs.

**** Plan
- Replace with ~Base64~ opam package or OCaml stdlib base64 if available

*** TODO Issue 79: No forward secrecy in crypto layer
:PROPERTIES:
:PRIORITY: C
:CATEGORY: security
:END:

[[file:lib/repl_crypto.ml][repl_crypto.ml]] — Uses a single pre-shared key for the entire session.
Compromise of the key exposes all past and future sessions using that
key. No ephemeral key exchange (e.g. DH, ECDH) is performed.

*** TODO Issue 80: No memory zeroization for key material
:PROPERTIES:
:PRIORITY: C
:CATEGORY: security
:END:

[[file:lib/repl_crypto.ml][repl_crypto.ml]] — OCaml's garbage collector does not support explicit
memory zeroization. Key material in OCaml strings/bytes may persist in
memory after use, potentially recoverable via memory dump.

This is a fundamental OCaml limitation. Mitigation would require C stubs
with ~explicit_bzero~ on pinned memory, which adds significant complexity.

*** TODO Issue 81: No security-focused tests for remote REPL
:PROPERTIES:
:PRIORITY: B
:CATEGORY: testing
:END:

Zero security-focused tests across all remote REPL modules: no tests for
malformed frames, oversized payloads, path traversal attempts, invalid
tokens, buffer overflow attempts, or concurrent connection abuse.

**** Plan
- Add adversarial test cases to each module's test file:
  - ~test_repl_protocol.ml~: malformed frames, oversized headers, truncated payloads
  - ~test_repl_server.ml~: path traversal in commands, oversized eval, invalid tokens
  - ~test_repl_client.ml~: malicious server responses, buffer growth limits
  - ~test_ssh_connect.ml~: flag injection, port validation edge cases
